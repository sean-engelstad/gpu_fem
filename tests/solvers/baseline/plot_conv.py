import numpy as np
import matplotlib.pyplot as plt
import niceplots

# GMRES convergence of each case, below with AMD reordering only

## GPU ----------------------

GPU_nnz = np.array([679666, 1047784, 1141152])

# with nnz = 679,666
GPU_ILU3 = np.array([8.190580022e+01, 2.750055327e+01, 8.339948076e+00, 2.699703384e+00, 1.990911595e+00, 1.943802128e+00, 1.824831204e+00, 1.575307286e+00, 1.484040132e+00, 1.216620714e+00, 1.177232396e+00, 1.009964299e+00, 9.655297440e-01, 9.003700993e-01, 7.637062477e-01, 7.404628199e-01, 6.447313526e-01, 6.315538285e-01, 5.710597879e-01, 5.710580182e-01, 4.974813204e-01, 4.862579147e-01, 4.382803480e-01, 4.305340092e-01, 3.896213568e-01, 3.873805496e-01, 3.393845326e-01, 3.200349093e-01, 3.163959131e-01, 2.988903877e-01, 2.948029974e-01, 2.880106380e-01, 2.785040628e-01, 2.706236106e-01, 2.704916420e-01, 2.575286058e-01, 2.436973018e-01, 2.369945328e-01, 2.278373114e-01, 2.257125407e-01, 2.156490672e-01, 2.148102930e-01, 2.108712406e-01, 2.064749461e-01, 2.032200447e-01, 1.986525663e-01, 1.984230813e-01, 1.864940410e-01, 1.847768769e-01, 1.833702366e-01, 1.791512237e-01, 1.729751712e-01, 1.708265565e-01, 1.705814778e-01, 1.619642790e-01, 1.593771567e-01, 1.583440850e-01, 1.545736587e-01, 1.543821753e-01, 1.516089147e-01, 1.492717838e-01, 1.491761353e-01, 1.436772208e-01, 1.434898067e-01, 1.382434959e-01, 1.379305865e-01, 1.352667212e-01, 1.338287116e-01, 1.326650998e-01, 1.292960662e-01, 1.285930591e-01, 1.251150149e-01, 1.247672892e-01, 1.222124667e-01, 1.218430139e-01, 1.179392448e-01, 1.179382333e-01, 1.150371216e-01, 1.149856129e-01, 1.130911428e-01, 1.123370464e-01, 1.112804972e-01, 1.097950199e-01, 1.086040800e-01, 1.070585778e-01, 1.064614502e-01, 1.047882924e-01, 1.046279719e-01, 1.025636332e-01, 1.025559389e-01, 1.003919666e-01, 1.002900204e-01, 9.833349978e-02, 9.833159270e-02, 9.560473999e-02, 9.552499254e-02, 9.377372277e-02, 9.350229408e-02, 9.174805544e-02, 9.032429238e-02, 8.971844595e-02, 8.734760874e-02, 8.707563362e-02, 8.531099553e-02, 8.531078822e-02, 8.328144999e-02, 8.240924986e-02, 8.180495762e-02, 8.049411778e-02, 8.020841647e-02, 7.848901728e-02, 7.845748079e-02, 7.734687072e-02, 7.666214264e-02, 7.524442744e-02, 7.522966746e-02, 7.302697117e-02, 7.266048419e-02, 7.108571722e-02, 6.993955639e-02, 6.927252810e-02, 6.715885924e-02, 6.699755199e-02, 6.461621315e-02, 6.438309846e-02, 6.287106114e-02, 6.222221599e-02, 6.142762959e-02, 6.015132866e-02, 5.951579663e-02, 5.800856975e-02, 5.794564147e-02, 5.568616017e-02, 5.564526038e-02, 5.401426453e-02, 5.399495201e-02, 5.201214792e-02, 5.187110895e-02, 5.035605510e-02, 5.014112675e-02, 4.879576226e-02, 4.828485806e-02, 4.772758160e-02, 4.632801212e-02, 4.591073498e-02, 4.382243225e-02, 4.380832554e-02, 4.221357615e-02, 4.199180279e-02, 4.100593103e-02, 4.084391225e-02, 3.962774232e-02, 3.912454184e-02, 3.885451949e-02, 3.714019546e-02, 3.707333003e-02, 3.616261582e-02, 3.541424656e-02, 3.507177242e-02, 3.354355213e-02, 3.336118872e-02, 3.174442057e-02, 3.170068851e-02, 3.047675204e-02, 3.020704239e-02, 2.913344245e-02, 2.880628750e-02, 2.810735941e-02, 2.721133601e-02, 2.674270913e-02, 2.592149467e-02, 2.578514160e-02, 2.487403823e-02, 2.479352409e-02, 2.379036599e-02, 2.378884406e-02, 2.286599878e-02, 2.280594674e-02, 2.214919137e-02, 2.208641371e-02, 2.152596479e-02, 2.118999693e-02, 2.085123965e-02, 2.054126793e-02, 2.036595076e-02, 1.995998168e-02, 1.979056285e-02, 1.939320415e-02, 1.922889550e-02, 1.878921539e-02, 1.874843299e-02, 1.831313702e-02, 1.828371187e-02, 1.766148726e-02, 1.764861144e-02, 1.721873131e-02, 1.714559417e-02, 1.674996614e-02, 1.665220268e-02, 1.628894464e-02, ])

# with nnz = 1,047,784
GPU_ILU8 = np.array([2.643097389e+00, 2.256601433e+00, 1.016709275e+00, 5.602768740e-01, 3.158026312e-01, 3.157533987e-01, 2.594173267e-01, 2.585684170e-01, 2.361240922e-01, 1.962701654e-01, 1.957705956e-01, 1.746637596e-01, 1.619013268e-01, 1.582088718e-01, 1.581637073e-01, 1.243979354e-01, 1.243914045e-01, 9.484281702e-02, 9.112651189e-02, 8.365169884e-02, 7.987141484e-02, 7.888024360e-02, 6.795453832e-02, 6.589262906e-02, 6.029193461e-02, 5.601170898e-02, 5.332680313e-02, 4.475590594e-02, 4.452632105e-02, 3.851101719e-02, 3.840692160e-02, 3.368294364e-02, 3.329201756e-02, 3.096438701e-02, 2.987643212e-02, 2.950389302e-02, 2.768052690e-02, 2.703385268e-02, 2.522105720e-02, 2.521881957e-02, 2.346059969e-02, 2.341890467e-02, 2.227397736e-02, 2.162631996e-02, 2.141106534e-02, 2.054553214e-02, 2.046169476e-02, 1.962889110e-02, 1.943497777e-02, 1.934766961e-02, 1.898403765e-02, 1.897125611e-02, 1.844355696e-02, 1.839022685e-02, 1.784420973e-02, 1.760582863e-02, 1.745663678e-02, 1.701511811e-02, 1.701391645e-02, 1.647945501e-02, 1.646837352e-02, 1.621481356e-02, 1.613337337e-02, 1.600487069e-02, 1.575998788e-02, 1.556535188e-02, 1.531382170e-02, 1.531146695e-02, 1.454190573e-02, 1.433971524e-02, 1.429319992e-02, 1.372117862e-02, 1.369242249e-02, 1.349609054e-02, 1.247822749e-02, 1.240426753e-02, 1.183920512e-02, 1.181470730e-02, 1.126076329e-02, 1.066651087e-02, 1.066424959e-02, 1.017364862e-02, 1.006609202e-02, 9.804983458e-03, 9.453029908e-03, 9.432424883e-03, 9.222206853e-03, 9.034027098e-03, 9.033986644e-03, 8.766853858e-03, 8.472617545e-03, 8.353180370e-03, 8.339372887e-03, 8.097463841e-03, 8.022668517e-03, 8.008859872e-03, 7.870217514e-03, 7.728596555e-03, 7.717533845e-03, 7.658414531e-03, 7.497504105e-03, 7.464443537e-03, 7.413234088e-03, 7.276283745e-03, 7.234461611e-03, 7.214287110e-03, 7.091335253e-03, 7.029792245e-03, 7.029791849e-03, 6.969592718e-03, 6.834198675e-03, 6.691955131e-03, 6.632820007e-03, 6.632808611e-03, 6.572612008e-03, 6.434432293e-03, 6.389217274e-03, 6.351421755e-03, 6.214006633e-03, 6.147309193e-03, 6.146382899e-03, 6.089993022e-03, 5.916362582e-03, 5.841237451e-03, 5.841237175e-03, 5.764957856e-03, 5.671794205e-03, 5.620205518e-03, 5.620205344e-03, 5.572753739e-03, 5.549542092e-03, 5.547155474e-03, 5.513284053e-03, 5.492918513e-03, 5.491825696e-03, 5.463382152e-03, 5.429606085e-03, 5.429595760e-03, 5.391659528e-03, 5.381195669e-03, 5.380509445e-03, 5.376148007e-03, 5.367909594e-03, 5.354324889e-03, 5.352360493e-03, 5.351413988e-03, 5.344952401e-03, 5.329051675e-03, 5.318549814e-03, 5.316746990e-03, 5.295897297e-03, 5.289864871e-03, 5.284719191e-03, 5.265510441e-03, 5.263857053e-03, 5.263753839e-03, 5.261815979e-03, 5.256802104e-03, 5.254655414e-03, 5.253243642e-03, 5.252850299e-03, 5.251161456e-03, 5.242740281e-03, 5.235082498e-03, 5.230591515e-03, 5.228359664e-03, 5.227965565e-03, 5.221810644e-03, 5.219044927e-03, 5.218618673e-03, 5.215306846e-03, 5.215304895e-03, 5.211347413e-03, 5.207208146e-03, 5.205462706e-03, 5.202877789e-03, 5.200336758e-03, 5.197322875e-03, 5.185013387e-03, 5.180914831e-03, 5.171074252e-03, 5.168114826e-03, 5.168110747e-03, 5.167705894e-03, 5.167379941e-03, 5.156040618e-03, 5.133863006e-03, 5.116828374e-03, 5.099467091e-03, 5.075338235e-03, 5.066620952e-03, 5.066038260e-03, 5.066035171e-03, 5.052897513e-03, 5.040521321e-03, 5.028002962e-03, 5.024643462e-03, 5.022427571e-03, 5.007101971e-03, 4.992536868e-03, ])

# with nnz = 1,141,152
GPU_ILU10 = np.array([3.548562589e-01, 3.055706293e-01, 2.964855602e-01, 2.282938311e-01, 2.127523191e-01, 2.080588215e-01, 1.972118251e-01, 1.736480157e-01, 1.736454294e-01, 9.085666180e-02, 8.485746863e-02, 8.129778815e-02, 6.857300737e-02, 6.836516144e-02, 5.747467929e-02, 4.917338132e-02, 4.200047145e-02, 4.199867590e-02, 3.798468965e-02, 3.455994860e-02, 3.423737756e-02, 3.382352642e-02, 3.195894860e-02, 2.855972102e-02, 2.752494908e-02, 2.738693158e-02, 2.711037744e-02, 2.635766199e-02, 2.584168720e-02, 2.563953419e-02, 2.507364978e-02, 2.457975835e-02, 2.445226300e-02, 2.445214967e-02, 2.413834375e-02, 2.355629804e-02, 2.305325452e-02, 2.291872175e-02, 2.290749285e-02, 2.268682548e-02, 2.235446663e-02, 2.223447301e-02, 2.218739645e-02, 2.181959745e-02, 2.126306583e-02, 2.075302624e-02, 2.049548715e-02, 2.048767324e-02, 2.014479831e-02, 1.963309128e-02, 1.928445735e-02, 1.897557977e-02, 1.887507739e-02, 1.882827805e-02, 1.847947627e-02, 1.807064768e-02, 1.764763195e-02, 1.725389431e-02, 1.710785152e-02, 1.710572022e-02, 1.688041046e-02, 1.642235317e-02, 1.623241490e-02, 1.617351540e-02, 1.616638187e-02, 1.611719886e-02, 1.596638833e-02, 1.578997806e-02, 1.562554499e-02, 1.547342393e-02, 1.527715053e-02, 1.513318314e-02, 1.507413625e-02, 1.507162696e-02, 1.504054475e-02, 1.489583025e-02, 1.469343525e-02, 1.456857235e-02, 1.444989104e-02, 1.429645630e-02, 1.412955469e-02, 1.398415037e-02, 1.393637473e-02, 1.393534603e-02, 1.386190864e-02, 1.363391659e-02, 1.336969904e-02, 1.289270967e-02, 1.211047932e-02, 1.101571443e-02, 9.931812803e-03, 9.212284480e-03, 8.641052565e-03, 8.071049570e-03, 7.641025281e-03, 6.977892927e-03, 5.930518697e-03, 4.880367300e-03, 4.126731993e-03, 3.568852691e-03, 3.148038910e-03, 2.946527454e-03, 2.873229869e-03, 2.831070996e-03, 2.778440330e-03, 2.702699053e-03, 2.587259374e-03, 2.425150156e-03, 2.217874989e-03, 2.034382217e-03, 1.905879263e-03, 1.793687371e-03, 1.675329202e-03, 1.526678347e-03, 1.365851176e-03, 1.262811488e-03, 1.194585394e-03, 1.151007278e-03, 1.124215888e-03, 1.092632115e-03, 1.026198089e-03, 9.217178808e-04, 8.368405174e-04, 7.608603225e-04, 6.976758489e-04, 6.682923692e-04, 6.516085305e-04, 6.426850166e-04, 6.359500956e-04, 6.294759111e-04, 6.230305269e-04, 6.157506928e-04, 6.077942365e-04, 5.980416765e-04, 5.838600989e-04, 5.541752761e-04, 5.063869781e-04, 4.521733761e-04, 3.980620519e-04, 3.579630922e-04, 3.055123174e-04, 2.604017312e-04, 2.296574412e-04, 2.075464856e-04, 1.938145178e-04, 1.866013004e-04, 1.827712151e-04, 1.797495117e-04, 1.774759765e-04, 1.745254836e-04, 1.696695340e-04, 1.627643292e-04, 1.503061790e-04, 1.303158932e-04, 1.071524109e-04, 8.093294242e-05, 5.916845307e-05, 4.257681967e-05, 2.960005613e-05, 2.270052311e-05, 1.759649155e-05, 1.381117226e-05, 9.864317919e-06, 5.837201864e-06, 3.019575619e-06, 1.672229760e-06, 1.108536041e-06, 8.514365235e-07, 6.842550866e-07, 5.535510845e-07, 4.483306119e-07, 3.690645697e-07, 2.937652942e-07, 2.396103032e-07, 1.870845211e-07, 1.189083479e-07, 6.913438475e-08, 4.056215364e-08, 2.376090720e-08, 1.408852107e-08, 7.406654244e-09, 3.875192592e-09, 2.210283738e-09, 1.402115939e-09, 9.091497319e-10, 5.395920116e-10, 3.046532178e-10, 1.545218573e-10, 7.251540033e-11, 4.089213978e-11, 2.851989111e-11, 1.976606274e-11, 1.459409752e-11, 9.616653716e-12, ])

## CPU ----------------------

# with nnz = 681080
CPU_ILU3 = np.array([1.49495819e+04, 1.49140007e+04, 1.48042475e+04, 1.45944512e+04, 1.45544452e+04, 1.45130377e+04, 1.45065987e+04, 1.44220609e+04, 1.42134590e+04, 1.40346786e+04, 1.38279512e+04, 1.36931616e+04, 1.35155153e+04, 1.34196375e+04, 1.33751799e+04, 1.33510750e+04, 1.32982553e+04, 1.32255785e+04, 1.31323228e+04, 1.30427446e+04, 1.29252694e+04, ])

# with nnz = 1047328
CPU_ILU8 = np.array([1.49495819e+04, 1.49304056e+04, 1.48837601e+04, 1.48608955e+04, 1.46829378e+04, 1.43675186e+04, 1.38764155e+04, 1.32520416e+04, 1.19499805e+04, 1.15031124e+04, 1.12537951e+04, 9.17330282e+03, 6.81461340e+03, 1.10461599e+03, 3.09486109e+01, 1.17435478e-02, 2.30050768e-06, ])

# with nnz = 1138354
CPU_ILU10 = np.array([1.49495819e+04, 1.49381144e+04, 1.49122171e+04, 1.48206553e+04, 1.32174968e+04, 1.22526009e+04, 1.17299160e+04, 9.44750890e+03, 4.69249008e+03, 1.72796232e+02, 3.16475601e-01, 3.37666575e-05, ])

# now plot ----------------

plt.style.use(niceplots.get_style())
fig, ax = plt.subplots(1, 2, figsize=(8,6))

ILU_vec = np.array([3, 8, 10])

for i,arr in enumerate([GPU_ILU3, GPU_ILU8, GPU_ILU10]):
    iterations = np.array([_ for _ in range(arr.shape[0])])
    ax[0].plot(iterations, arr, label=f"GPU_ILU{ILU_vec[i]}")
ax[0].set_yscale('log')
ax[0].legend()
ax[0].set_xlabel("Search directions")
ax[0].set_ylabel("Left precond resid")

for i,arr in enumerate([CPU_ILU3, CPU_ILU8, CPU_ILU10]):
    iterations = np.array([_ for _ in range(arr.shape[0])])
    ax[1].plot(iterations*10, arr, label=f"CPU_ILU{ILU_vec[i]}")
ax[1].set_yscale('log')
ax[1].legend()
ax[1].set_xlabel("Search directions")
ax[1].set_ylabel("Right precond resid")
# plt.show()
plt.savefig("gpu_cpu_gmres_conv.png", dpi=400)
