#include "utils//local_utils.h"
#include "chrono"
#include "linalg/_linalg.h"
#include "../test_commons.h"

// shell imports
#include "assembler.h"
#include "element/shell/physics/isotropic_shell.h"
#include "element/shell/shell_elem_group.h"

template <bool is_nonlinear>
void test_kelem_gpu() {

  using T = double;
  bool print = false;

  // T jac_TD_ref = -1.62871890e+18;
  T cpu_kelem_ref_nl[] = {2.57276e+14,2.50851e+14,2.03465e+14,2.01742e+12,-2.15387e+11,-2.44943e+12,-2.96042e+14,-2.85420e+14,-2.65673e+14,4.90272e+12,2.84413e+09,-4.89934e+12,-3.11905e+14,-2.31121e+14,-1.53394e+14,3.26729e+12,2.43743e+11,-2.77970e+12,3.50671e+14,2.65690e+14,2.15601e+14,3.81964e+11,2.56897e+10,-3.29931e+11,
    2.50851e+14,2.13930e+14,2.62631e+14,5.52505e+11,8.31391e+09,-5.37275e+11,-2.84401e+14,-2.81603e+14,-3.00755e+14,4.86153e+11,1.19334e+10,-4.64862e+11,-2.34366e+14,-2.39297e+14,-2.40436e+14,5.89009e+10,6.70883e+09,-4.53372e+10,2.67916e+14,3.06969e+14,2.78560e+14,1.25153e+11,3.28553e+09,-1.17846e+11,
    2.03465e+14,2.62631e+14,2.77487e+14,-7.70025e+11,2.36349e+11,1.24117e+12,-2.62888e+14,-2.99736e+14,-3.24111e+14,-3.76532e+12,2.71387e+10,3.81676e+12,-1.61067e+14,-2.43681e+14,-3.27221e+14,-3.05773e+12,-2.26593e+11,2.60473e+12,2.20490e+14,2.80786e+14,3.73845e+14,-6.26097e+10,-1.71688e+10,2.90902e+10,
    2.01742e+12,5.52505e+11,-7.70025e+11,4.11174e+12,9.97542e+10,-3.91079e+12,-3.20616e+12,-4.44913e+11,2.17395e+12,1.15871e+12,3.11725e+10,-1.09522e+12,1.04167e+13,1.40616e+11,-9.99830e+12,-1.19425e+11,-9.56345e+09,9.91510e+10,-9.22794e+12,-2.48208e+11,8.59438e+12,2.83363e+12,5.89221e+10,-2.71636e+12,
    -2.15387e+11,8.31391e+09,2.36349e+11,9.97542e+10,3.41401e+09,-9.57929e+10,9.21836e+10,-8.95125e+09,-1.14420e+11,3.00204e+10,1.62054e+09,-2.90727e+10,3.15717e+11,5.85246e+09,-3.01268e+11,-8.67410e+08,-9.36491e+08,1.28785e+09,-1.92513e+11,-5.21511e+09,1.79339e+11,6.87703e+10,1.04808e+09,-6.55274e+10,
    -2.44943e+12,-5.37275e+11,1.24117e+12,-3.91079e+12,-9.57929e+10,3.72064e+12,3.39344e+12,4.30320e+11,-2.39908e+12,-1.09752e+12,-3.02248e+10,1.03822e+12,-9.78757e+12,-1.31559e+11,9.39280e+12,1.16543e+11,9.98389e+09,-9.77220e+10,8.84356e+12,2.38514e+11,-8.23488e+12,-2.69667e+12,-5.56793e+10,2.58473e+12,
    -2.96042e+14,-2.84401e+14,-2.62888e+14,-3.20616e+12,9.21836e+10,3.39344e+12,3.96736e+14,3.24400e+14,3.13516e+14,-1.01015e+13,-4.67814e+11,9.17040e+12,2.35755e+14,2.60594e+14,2.51826e+14,-7.99098e+12,-1.96897e+11,7.59444e+12,-3.36449e+14,-3.00594e+14,-3.02454e+14,-1.09532e+12,3.62581e+11,1.81771e+12,
    -2.85420e+14,-2.81603e+14,-2.99736e+14,-4.44913e+11,-8.95125e+09,4.30320e+11,3.24400e+14,3.94348e+14,3.43600e+14,-9.82204e+10,-1.27670e+10,7.77637e+10,2.65474e+14,2.35692e+14,2.73480e+14,-1.66664e+11,-5.72734e+09,1.52118e+11,-3.04455e+14,-3.48437e+14,-3.17343e+14,-5.13063e+11,-2.50026e+09,5.04971e+11,
    -2.65673e+14,-3.00755e+14,-3.24111e+14,2.17395e+12,-1.14420e+11,-2.39908e+12,3.13516e+14,3.43600e+14,4.33279e+14,9.73998e+12,4.36164e+11,-8.86201e+12,2.63753e+14,2.78360e+14,2.59196e+14,7.56590e+12,1.81710e+11,-7.20591e+12,-3.11597e+14,-3.21204e+14,-3.68365e+14,1.45767e+08,-3.69531e+11,-7.42620e+11,
    4.90272e+12,4.86153e+11,-3.76532e+12,1.15871e+12,3.00204e+10,-1.09752e+12,-1.01015e+13,-9.82204e+10,9.73998e+12,1.12923e+13,2.49243e+11,-1.07907e+13,3.59967e+13,1.03497e+12,-3.33549e+13,9.97810e+12,2.07823e+11,-9.56302e+12,-3.07979e+13,-1.42291e+12,2.73802e+13,-1.55274e+11,-1.18768e+10,1.30374e+11,
    2.84413e+09,1.19334e+10,2.71387e+10,3.11725e+10,1.62054e+09,-3.02248e+10,-4.67814e+11,-1.27670e+10,4.36164e+11,2.49243e+11,7.76537e+09,-2.40019e+11,6.65660e+11,2.07389e+10,-6.13298e+11,2.18833e+11,4.25275e+09,-2.09180e+11,-2.00690e+11,-1.99053e+10,1.49995e+11,2.84508e+08,-9.36497e+08,1.35920e+08,
    -4.89934e+12,-4.64862e+11,3.81676e+12,-1.09522e+12,-2.90727e+10,1.03822e+12,9.17040e+12,7.77637e+10,-8.86201e+12,-1.07907e+13,-2.40019e+11,1.03138e+13,-3.46681e+13,-9.96586e+11,3.21248e+13,-9.54101e+12,-1.98171e+11,9.14409e+12,3.03970e+13,1.38368e+12,-2.70796e+13,1.54696e+11,1.22973e+10,-1.31249e+11,
    -3.11905e+14,-2.34366e+14,-1.61067e+14,1.04167e+13,3.15717e+11,-9.78757e+12,2.35755e+14,2.65474e+14,2.63753e+14,3.59967e+13,6.65660e+11,-3.46681e+13,6.86819e+14,2.23272e+14,-7.61633e+13,3.10558e+13,-5.11181e+11,-3.20737e+13,-6.10668e+14,-2.54380e+14,-2.65227e+13,5.47536e+12,-8.60615e+11,-7.19323e+12,
    -2.31121e+14,-2.39297e+14,-2.43681e+14,1.40616e+11,5.85246e+09,-1.31559e+11,2.60594e+14,2.35692e+14,2.78360e+14,1.03497e+12,2.07389e+10,-9.96586e+11,2.23272e+14,3.81511e+14,2.20686e+14,1.91733e+12,1.36992e+10,-1.88485e+12,-2.52745e+14,-3.77906e+14,-2.55365e+14,1.02268e+12,-5.98534e+08,-1.02013e+12,
    -1.53394e+14,-2.40436e+14,-3.27221e+14,-9.99830e+12,-3.01268e+11,9.39280e+12,2.51826e+14,2.73480e+14,2.59196e+14,-3.33549e+13,-6.13298e+11,3.21248e+13,-7.61633e+13,2.20686e+14,6.72904e+14,-2.67227e+13,5.47079e+11,2.78225e+13,-2.22691e+13,-2.53730e+14,-6.04879e+14,-3.36619e+12,8.59778e+11,5.08990e+12,
    3.26729e+12,5.89009e+10,-3.05773e+12,-1.19425e+11,-8.67410e+08,1.16543e+11,-7.99098e+12,-1.66664e+11,7.56590e+12,9.97810e+12,2.18833e+11,-9.54101e+12,3.10558e+13,1.91733e+12,-2.67227e+13,9.15769e+12,1.90859e+11,-8.77282e+12,-2.63322e+13,-1.80956e+12,2.22145e+13,-9.40071e+11,-2.83630e+10,8.84491e+11,
    2.43743e+11,6.70883e+09,-2.26593e+11,-9.56345e+09,-9.36491e+08,9.98389e+09,-1.96897e+11,-5.72734e+09,1.81710e+11,2.07823e+11,4.25275e+09,-1.98171e+11,-5.11181e+11,1.36992e+10,5.47079e+11,1.90859e+11,6.22523e+09,-1.84716e+11,4.64335e+11,-1.46807e+10,-5.02196e+11,-2.60498e+10,8.04010e+07,2.39172e+10,
    -2.77970e+12,-4.53372e+10,2.60473e+12,9.91510e+10,1.28785e+09,-9.77220e+10,7.59444e+12,1.52118e+11,-7.20591e+12,-9.56302e+12,-2.09180e+11,9.14409e+12,-3.20737e+13,-1.88485e+12,2.78225e+13,-8.77282e+12,-1.84716e+11,8.40654e+12,2.72590e+13,1.77807e+12,-2.32213e+13,8.89118e+11,2.62304e+10,-8.35510e+11,
    3.50671e+14,2.67916e+14,2.20490e+14,-9.22794e+12,-1.92513e+11,8.84356e+12,-3.36449e+14,-3.04455e+14,-3.11597e+14,-3.07979e+13,-2.00690e+11,3.03970e+13,-6.10668e+14,-2.52745e+14,-2.22691e+13,-2.63322e+13,4.64335e+11,2.72590e+13,5.96445e+14,2.89284e+14,1.13376e+14,-4.76201e+12,4.72345e+11,5.70545e+12,
    2.65690e+14,3.06969e+14,2.80786e+14,-2.48208e+11,-5.21511e+09,2.38514e+11,-3.00594e+14,-3.48437e+14,-3.21204e+14,-1.42291e+12,-1.99053e+10,1.38368e+12,-2.54380e+14,-3.77906e+14,-2.53730e+14,-1.80956e+12,-1.46807e+10,1.77807e+12,2.89284e+14,4.19374e+14,2.94148e+14,-6.34772e+11,-1.86737e+08,6.33001e+11,
    2.15601e+14,2.78560e+14,3.73845e+14,8.59438e+12,1.79339e+11,-8.23488e+12,-3.02454e+14,-3.17343e+14,-3.68365e+14,2.73802e+13,1.49995e+11,-2.70796e+13,-2.65227e+13,-2.55365e+14,-6.04879e+14,2.22145e+13,-5.02196e+11,-2.32213e+13,1.13376e+14,2.94148e+14,5.99398e+14,3.42866e+12,-4.73079e+11,-4.37637e+12,
    3.81964e+11,1.25153e+11,-6.26097e+10,2.83363e+12,6.87703e+10,-2.69667e+12,-1.09532e+12,-5.13063e+11,1.45767e+08,-1.55274e+11,2.84508e+08,1.54696e+11,5.47536e+12,1.02268e+12,-3.36619e+12,-9.40071e+11,-2.60498e+10,8.89118e+11,-4.76201e+12,-6.34772e+11,3.42866e+12,2.04881e+12,4.25322e+10,-1.96231e+12,
    2.56897e+10,3.28553e+09,-1.71688e+10,5.89221e+10,1.04808e+09,-5.56793e+10,3.62581e+11,-2.50026e+09,-3.69531e+11,-1.18768e+10,-9.36497e+08,1.22973e+10,-8.60615e+11,-5.98534e+08,8.59778e+11,-2.83630e+10,8.04010e+07,2.62304e+10,4.72345e+11,-1.86737e+08,-4.73079e+11,4.25322e+10,1.87388e+09,-4.16512e+10,
    -3.29931e+11,-1.17846e+11,2.90902e+10,-2.71636e+12,-6.55274e+10,2.58473e+12,1.81771e+12,5.04971e+11,-7.42620e+11,1.30374e+11,1.35920e+08,-1.31249e+11,-7.19323e+12,-1.02013e+12,5.08990e+12,8.84491e+11,2.39172e+10,-8.35510e+11,5.70545e+12,6.33001e+11,-4.37637e+12,-1.96231e+12,-4.16512e+10,1.88044e+12};


  T cpu_kelem_ref_lin[] = {2.14657e+13,2.37767e+13,2.60969e+13,1.94626e+09,1.13632e+09,-9.15577e+08,-2.57778e+13,-2.83280e+13,-3.08874e+13,-3.31859e+09,1.79052e+09,4.58605e+09,-2.64154e+13,-2.82865e+13,-3.01626e+13,-3.26848e+09,5.86994e+08,4.54741e+09,3.07275e+13,3.28378e+13,3.49531e+13,1.90922e+09,1.07098e+08,-1.04137e+09,
    2.37767e+13,2.64174e+13,2.90397e+13,-4.53952e+09,-9.78640e+08,1.18416e+09,-2.86608e+13,-3.15740e+13,-3.44689e+13,5.43656e+09,-1.17980e+09,-1.03727e+10,-2.93892e+13,-3.15179e+13,-3.36367e+13,6.59627e+09,-1.29263e+09,-9.03550e+09,3.42733e+13,3.66745e+13,3.90658e+13,-3.47792e+09,-8.95245e+08,2.42327e+09,
    2.60969e+13,2.90397e+13,3.19918e+13,1.89422e+09,1.24041e+09,-9.67624e+08,-3.15530e+13,-3.48017e+13,-3.80595e+13,-3.40625e+09,1.96584e+09,4.49839e+09,-3.23679e+13,-3.47394e+13,-3.71158e+13,-3.25478e+09,5.59601e+08,4.56110e+09,3.78241e+13,4.05013e+13,4.31835e+13,1.93662e+09,5.23108e+07,-1.01398e+09,
    1.94626e+09,-4.53952e+09,1.89422e+09,3.17245e+11,2.63179e+10,-2.63176e+11,-1.66731e+09,4.85820e+09,-1.53582e+09,7.18238e+10,5.60068e+09,-5.94757e+10,8.80477e+09,-1.88267e+10,8.69794e+09,6.15054e+10,-4.42509e+09,-7.15023e+10,-9.08373e+09,1.85080e+10,-9.05633e+09,3.06975e+11,1.61966e+10,-2.75155e+11,
    1.13632e+09,-9.78640e+08,1.24041e+09,2.63179e+10,3.41401e+09,-2.23567e+10,-1.69422e+09,3.41293e+08,-1.95720e+09,4.44855e+09,1.62054e+09,-3.50090e+09,1.23322e+09,-3.22422e+07,1.44689e+09,4.27095e+09,-9.36491e+08,-3.85051e+09,-6.75319e+08,6.69588e+08,-7.30106e+08,2.60448e+10,1.04808e+09,-2.28019e+10,
    -9.15577e+08,1.18416e+09,-9.67624e+08,-2.63176e+11,-2.23567e+10,2.19896e+11,1.19453e+09,-8.65483e+08,1.32602e+09,-6.17800e+10,-4.65303e+09,5.36206e+10,-8.66570e+09,1.61143e+10,-8.77253e+09,-5.41102e+10,4.84553e+09,6.26546e+10,8.38674e+09,-1.64330e+10,8.41414e+09,-2.55458e+11,-1.29537e+10,2.28978e+11,
    -2.57778e+13,-2.86608e+13,-3.15530e+13,-1.66731e+09,-1.69422e+09,1.19453e+09,3.11386e+13,3.43237e+13,3.75179e+13,3.68470e+09,-2.52274e+09,-4.21994e+09,3.19097e+13,3.42303e+13,3.65559e+13,2.82841e+09,2.93144e+08,-4.98748e+09,-3.72704e+13,-3.98931e+13,-4.25208e+13,-2.26214e+09,5.98732e+08,6.88457e+08,
    -2.83280e+13,-3.15740e+13,-3.48017e+13,4.85820e+09,3.41293e+08,-8.65483e+08,3.43237e+13,3.79094e+13,4.14768e+13,-5.01977e+09,3.46229e+08,1.07895e+10,3.51861e+13,3.77892e+13,4.03823e+13,-7.08702e+09,2.27412e+09,8.54475e+09,-4.11818e+13,-4.41246e+13,-4.70574e+13,3.08529e+09,1.68052e+09,-2.81590e+09,
    -3.08874e+13,-3.44689e+13,-3.80595e+13,-1.53582e+09,-1.95720e+09,1.32602e+09,3.75179e+13,4.14768e+13,4.54448e+13,3.87371e+09,-2.90076e+09,-4.03093e+09,3.84676e+13,4.13381e+13,4.42136e+13,2.71336e+09,5.23248e+08,-5.10253e+09,-4.50981e+13,-4.83460e+13,-5.15990e+13,-2.36897e+09,8.12401e+08,5.81623e+08,
    -3.31859e+09,5.43656e+09,-3.40625e+09,7.18238e+10,4.44855e+09,-6.17800e+10,3.68470e+09,-5.01977e+09,3.87371e+09,1.39222e+12,8.00792e+10,-1.22891e+12,4.06642e+10,-8.27587e+10,4.05492e+10,1.38050e+12,6.93702e+10,-1.24233e+12,-4.10303e+10,8.23419e+10,-4.10166e+10,6.03444e+10,-6.73827e+09,-7.49676e+10,
    1.79052e+09,-1.17980e+09,1.96584e+09,5.60068e+09,1.62054e+09,-4.65303e+09,-2.52274e+09,3.46229e+08,-2.90076e+09,8.00792e+10,7.76537e+09,-7.08554e+10,2.72915e+09,-2.59789e+09,2.95925e+09,8.03794e+10,4.25275e+09,-7.07272e+10,-1.99693e+09,3.43146e+09,-2.02433e+09,5.42307e+09,-9.36497e+08,-5.00265e+09,
    4.58605e+09,-1.03727e+10,4.49839e+09,-5.94757e+10,-3.50090e+09,5.36206e+10,-4.21994e+09,1.07895e+10,-4.03093e+09,-1.22891e+12,-7.08554e+10,1.09035e+12,-3.79513e+10,7.44724e+10,-3.80663e+10,-1.22032e+12,-5.97180e+10,1.10031e+12,3.75852e+10,-7.48892e+10,3.75989e+10,-5.06449e+10,7.15870e+09,6.38156e+10,
    -2.64154e+13,-2.93892e+13,-3.23679e+13,8.80477e+09,1.23322e+09,-8.66570e+09,3.19097e+13,3.51861e+13,3.84676e+13,4.06642e+10,2.72915e+09,-3.79513e+10,3.28070e+13,3.52118e+13,3.76273e+13,4.15205e+10,-8.67307e+07,-3.71838e+10,-3.83013e+13,-4.10087e+13,-4.37270e+13,9.39960e+09,-1.05973e+09,-8.15962e+09,
    -2.82865e+13,-3.15179e+13,-3.47394e+13,-1.88267e+10,-3.22422e+07,1.61143e+10,3.42303e+13,3.77892e+13,4.13381e+13,-8.27587e+10,-2.59789e+09,7.44724e+10,3.52118e+13,3.78341e+13,4.04349e+13,-8.06914e+10,-4.52578e+09,7.67171e+10,-4.11556e+13,-4.41054e+13,-4.70337e+13,-1.70537e+10,-1.37146e+09,1.80647e+10,
    -3.01626e+13,-3.36367e+13,-3.71158e+13,8.69794e+09,1.44689e+09,-8.77253e+09,3.65559e+13,4.03823e+13,4.42136e+13,4.05492e+10,2.95925e+09,-3.80663e+10,3.76273e+13,4.04349e+13,4.32533e+13,4.17095e+10,-4.64760e+08,-3.69947e+10,-4.40207e+13,-4.71805e+13,-5.03512e+13,9.53109e+09,-1.32271e+09,-8.02814e+09,
    -3.26848e+09,6.59627e+09,-3.25478e+09,6.15054e+10,4.27095e+09,-5.41102e+10,2.82841e+09,-7.08702e+09,2.71336e+09,1.38050e+12,8.03794e+10,-1.22032e+12,4.15205e+10,-8.06914e+10,4.17095e+10,1.37132e+12,6.77019e+10,-1.23276e+12,-4.10805e+10,8.11822e+10,-4.11681e+10,5.20805e+10,-7.92879e+09,-6.67914e+10,
    5.86994e+08,-1.29263e+09,5.59601e+08,-4.42509e+09,-9.36491e+08,4.84553e+09,2.93144e+08,2.27412e+09,5.23248e+08,6.93702e+10,4.25275e+09,-5.97180e+10,-8.67307e+07,-4.52578e+09,-4.64760e+08,6.77019e+10,6.22523e+09,-6.15583e+10,-7.93407e+08,3.54429e+09,-6.18089e+08,-5.61561e+09,8.04010e+07,3.48299e+09,
    4.54741e+09,-9.03550e+09,4.56110e+09,-7.15023e+10,-3.85051e+09,6.26546e+10,-4.98748e+09,8.54475e+09,-5.10253e+09,-1.24233e+12,-7.07272e+10,1.10031e+12,-3.71838e+10,7.67171e+10,-3.69947e+10,-1.23276e+12,-6.15583e+10,1.11280e+12,3.76238e+10,-7.62264e+10,3.75362e+10,-6.21650e+10,5.79617e+09,7.49041e+10,
    3.07275e+13,3.42733e+13,3.78241e+13,-9.08373e+09,-6.75319e+08,8.38674e+09,-3.72704e+13,-4.11818e+13,-4.50981e+13,-4.10303e+10,-1.99693e+09,3.75852e+10,-3.83013e+13,-4.11556e+13,-4.40207e+13,-4.10805e+10,-7.93407e+08,3.76238e+10,4.48442e+13,4.80640e+13,5.12947e+13,-9.04669e+09,3.53900e+08,8.51254e+09,
    3.28378e+13,3.66745e+13,4.05013e+13,1.85080e+10,6.69588e+08,-1.64330e+10,-3.98931e+13,-4.41246e+13,-4.83460e+13,8.23419e+10,3.43146e+09,-7.48892e+10,-4.10087e+13,-4.41054e+13,-4.71805e+13,8.11822e+10,3.54429e+09,-7.62264e+10,4.80640e+13,5.15554e+13,5.50253e+13,1.74464e+10,5.86194e+08,-1.76721e+10,
    3.49531e+13,3.90658e+13,4.31835e+13,-9.05633e+09,-7.30106e+08,8.41414e+09,-4.25208e+13,-4.70574e+13,-5.15990e+13,-4.10166e+10,-2.02433e+09,3.75989e+10,-4.37270e+13,-4.70337e+13,-5.03512e+13,-4.11681e+10,-6.18089e+08,3.75362e+10,5.12947e+13,5.50253e+13,5.87666e+13,-9.09873e+09,4.57995e+08,8.46049e+09,
    1.90922e+09,-3.47792e+09,1.93662e+09,3.06975e+11,2.60448e+10,-2.55458e+11,-2.26214e+09,3.08529e+09,-2.36897e+09,6.03444e+10,5.42307e+09,-5.06449e+10,9.39960e+09,-1.70537e+10,9.53109e+09,5.20805e+10,-5.61561e+09,-6.21650e+10,-9.04669e+09,1.74464e+10,-9.09873e+09,2.98663e+11,1.51016e+10,-2.67026e+11,
    1.07098e+08,-8.95245e+08,5.23108e+07,1.61966e+10,1.04808e+09,-1.29537e+10,5.98732e+08,1.68052e+09,8.12401e+08,-6.73827e+09,-9.36497e+08,7.15870e+09,-1.05973e+09,-1.37146e+09,-1.32271e+09,-7.92879e+09,8.04010e+07,5.79617e+09,3.53900e+08,5.86194e+08,4.57995e+08,1.51016e+10,1.87388e+09,-1.42207e+10,
    -1.04137e+09,2.42327e+09,-1.01398e+09,-2.75155e+11,-2.28019e+10,2.28978e+11,6.88457e+08,-2.81590e+09,5.81623e+08,-7.49676e+10,-5.00265e+09,6.38156e+10,-8.15962e+09,1.80647e+10,-8.02814e+09,-6.67914e+10,3.48299e+09,7.49041e+10,8.51254e+09,-1.76721e+10,8.46049e+09,-2.67026e+11,-1.42207e+10,2.40018e+11};


  using Quad = QuadLinearQuadrature<T>;
  using Director = LinearizedRotation<T>;
  using Basis = ShellQuadBasis<T, Quad, 2>;
  using Geo = Basis::Geo;

  constexpr bool has_ref_axis = false;
  using Data = ShellIsotropicData<T, has_ref_axis>;
  using Physics = IsotropicShell<T, Data, is_nonlinear>;

  using ElemGroup = ShellElementGroup<T, Director, Basis, Physics>;
  using Assembler = ElementAssembler<T, ElemGroup, VecType, DenseMat>;

  // printf("running!\n");
  int num_bcs = 2;
  auto assembler = createOneElementAssembler<Assembler>(num_bcs);

  // init variables u
  int num_vars = assembler.get_num_vars();
  auto res = assembler.createVarsVec();
  auto h_vars = HostVec<T>(num_vars);
  auto p_vars = HostVec<T>(num_vars);
  auto p_vars2 = HostVec<T>(num_vars);

  // fixed perturbations of the host and pert vars
  for (int ivar = 0; ivar < 24; ivar++) {
    h_vars[ivar] = (1.4543 + 6.4323 * ivar) * 1e-6;
    if (is_nonlinear) h_vars[ivar] *= 1e6;
    p_vars[ivar] = (-1.4543 + 2.312 * 6.4323 * ivar);
    p_vars2[ivar] = (-1.4543 * 1.024343 + 2.812 * -9.4323 * ivar);
  }

  auto vars = h_vars.createDeviceVec();
  assembler.set_variables(vars);

  DenseMat<VecType<T>> mat(num_vars);

  // time add residual method
  auto start = std::chrono::high_resolution_clock::now();

  assembler.add_jacobian(res, mat);

  auto stop = std::chrono::high_resolution_clock::now();
  auto duration =
      std::chrono::duration_cast<std::chrono::microseconds>(stop - start);

  // print res, jac
  auto h_res = res.createHostVec();
  auto h_mat = mat.createHostVec();
  T jac_TD = 0.0;
  T res_TD = 0.0;
  for (int i = 0; i < 24; i++) {
    res_TD += p_vars[i] * h_res[i];
    for (int j = 0; j < 24; j++) {
      jac_TD += p_vars[i] * p_vars2[j] * h_mat[24 * i + j];
    }
  }

  if (print) {
    printf("Analytic Jacobian GPU\n");
    printf("res TD = %.8e\n", res_TD);
    printf("jac TD = %.8e\n", jac_TD);
  }

  // print residual
  if (print) {
    printf("res: ");
    printVec<double>(num_vars, h_res.getPtr());
  }

  const double *h_mat_ptr = h_mat.getPtr();
  if (print) {
    for (int i = 0; i < 24; i++) {  // i < 2
      printf("kmat row %d: ", i);
      printVec<double>(num_vars, &h_mat_ptr[num_vars * i]);
    }
  }  

  if constexpr (is_nonlinear) {
    double max_ref = max(576, cpu_kelem_ref_nl);
    double max_abs_err = abs_err(h_mat, cpu_kelem_ref_nl);
    double my_rel_err = max_abs_err / max_ref;
    bool passed = my_rel_err < 1e-5;
    T max_rel_err = rel_err(h_mat, cpu_kelem_ref_nl, 1e-9);
    printTestReport("shell elem-jac geom nonlinear", passed, my_rel_err);
    printf("\tabs err %.4e, max ref %.4e, norm err %.4e, max rel err %.4e\n", max_abs_err, max_ref, my_rel_err, max_rel_err);
  } else {
    double max_ref = max(576, cpu_kelem_ref_lin);
    double max_abs_err = abs_err(h_mat, cpu_kelem_ref_lin);
    double my_rel_err = max_abs_err / max_ref;
    bool passed = my_rel_err < 1e-5;
    T max_rel_err = rel_err(h_mat, cpu_kelem_ref_lin, 1e-9);
    printTestReport("shell elem-jac linear", passed, my_rel_err);
    printf("\tabs err %.4e, max ref %.4e, norm err %.4e, max rel err %.4e\n", max_abs_err, max_ref, my_rel_err, max_rel_err);
  }

  printKernelTiming(duration.count());
}

int main(void) {

  test_kelem_gpu<false>(); // linear
  test_kelem_gpu<true>(); // nonlinear

  return 0;
};