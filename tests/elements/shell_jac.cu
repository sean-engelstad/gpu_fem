#include "utils//local_utils.h"
#include "chrono"
#include "linalg/_linalg.h"
#include "../test_commons.h"

// shell imports
#include "assembler.h"
#include "element/shell/physics/isotropic_shell.h"
#include "element/shell/shell_elem_group.h"

template <bool is_nonlinear>
void test_kelem_gpu() {

  using T = double;
  // bool print = false;
  bool print = true;

  // T jac_TD_ref = -1.62871890e+18;
  T cpu_kelem_ref_nl[] = {2.57276317304468e+14,2.50850534751452e+14,2.03465061155353e+14,2.01741697237997e+12,-2.15387372271122e+11,-2.44943366325928e+12,-2.96042255822047e+14,-2.85419577312062e+14,-2.65672842168990e+14,4.90271841791950e+12,2.84413208712192e+09,-4.89934373971060e+12,-3.11905429587867e+14,-2.31121170707019e+14,-1.53393710973641e+14,3.26729068365633e+12,2.43742901939782e+11,-2.77969993866464e+12,3.50671368105446e+14,2.65690213267629e+14,2.15601491987278e+14,3.81963688725529e+11,2.56897133949899e+10,-3.29930605968665e+11,
    2.50850534751452e+14,2.13929624606126e+14,2.62630889211484e+14,5.52504978363367e+11,8.31390622214082e+09,-5.37275254869314e+11,-2.84400531752578e+14,-2.81602511378765e+14,-3.00755396935646e+14,4.86152648222259e+11,1.19334280071769e+10,-4.64862355205941e+11,-2.34366285679009e+14,-2.39296600959407e+14,-2.40435810102826e+14,5.89009049096880e+10,6.70883042929357e+09,-4.53372127776341e+10,2.67916282680135e+14,3.06969487732046e+14,2.78560317826987e+14,1.25153119695329e+11,3.28553165481657e+09,-1.17846220096099e+11,
    2.03465061155353e+14,2.62630889211484e+14,2.77487136210952e+14,-7.70024774950210e+11,2.36349192357871e+11,1.24116892810256e+12,-2.62888197819280e+14,-2.99736351376162e+14,-3.24110558286377e+14,-3.76531907028098e+12,2.71386823653688e+10,3.81675689498098e+12,-1.61067094768938e+14,-2.43680925074816e+14,-3.27221339606963e+14,-3.05772926878262e+12,-2.26593392221346e+11,2.60472960577473e+12,2.20490231432865e+14,2.80786387239494e+14,3.73844761682387e+14,-6.26096547715093e+10,-1.71687520211773e+10,2.90901673414654e+10,
    2.01741697237997e+12,5.52504978363367e+11,-7.70024774950210e+11,4.11173511246049e+12,9.97541555613611e+10,-3.91079341214895e+12,-3.20615636429042e+12,-4.44912564247404e+11,2.17394899509258e+12,1.15870869347601e+12,3.11724862673932e+10,-1.09521700959018e+12,1.04166744342756e+13,1.40615679123466e+11,-9.99830208490579e+12,-1.19424561874221e+11,-9.56344826195196e+09,9.91509539992751e+10,-9.22793504236511e+12,-2.48208093239429e+11,8.59437786476342e+12,2.83363344845122e+12,5.89221363548777e+10,-2.71636253141695e+12,
    -2.15387372271122e+11,8.31390622214082e+09,2.36349192357871e+11,9.97541555613611e+10,3.41400831096716e+09,-9.57929173170285e+10,9.21836499746499e+10,-8.95125234497300e+09,-1.14420162307065e+11,3.00203572610117e+10,1.62053841487608e+09,-2.90727031333413e+10,3.15717076994426e+11,5.85245735539342e+09,-3.01267561026693e+11,-8.67410212607250e+08,-9.36490547169467e+08,1.28785182035007e+09,-1.92513354697953e+11,-5.21511123256119e+09,1.79338530975886e+11,6.87703034106073e+10,1.04808084586683e+09,-6.55274303678321e+10,
    -2.44943366325928e+12,-5.37275254869314e+11,1.24116892810256e+12,-3.91079341214895e+12,-9.57929173170285e+10,3.72064096670368e+12,3.39343932600940e+12,4.30320186876184e+11,-2.39908472683894e+12,-1.09752126760294e+12,-3.02248321397226e+10,1.03821831467454e+12,-9.78756765168616e+12,-1.31558639070770e+11,9.39279858493568e+12,1.16543030097965e+11,9.98388986969474e+09,-9.77219617096153e+10,8.84356198893604e+12,2.38513707063901e+11,-8.23488278619929e+12,-2.69666619730551e+12,-5.56792633121027e+10,2.58473431500575e+12,
    -2.96042255822047e+14,-2.84400531752578e+14,-2.62888197819280e+14,-3.20615636429042e+12,9.21836499746499e+10,3.39343932600940e+12,3.96736184816269e+14,3.24400105641657e+14,3.13516474841052e+14,-1.01015130219440e+13,-4.67813838103413e+11,9.17039557190861e+12,2.35754673364290e+14,2.60594395847247e+14,2.51826106769935e+14,-7.99098418719210e+12,-1.96896999570600e+11,7.59444483298994e+12,-3.36448602358512e+14,-3.00593969736327e+14,-3.02454383791707e+14,-1.09531948600636e+12,3.62580581306035e+11,1.81770950347625e+12,
    -2.85419577312062e+14,-2.81602511378765e+14,-2.99736351376162e+14,-4.44912564247404e+11,-8.95125234497300e+09,4.30320186876184e+11,3.24400105641657e+14,3.94347531037084e+14,3.43599745887534e+14,-9.82204125170920e+10,-1.27669971405675e+10,7.77636886341669e+10,2.65474346667515e+14,2.35691852672818e+14,2.73479990156423e+14,-1.66663636611804e+11,-5.72733671501487e+09,1.52118450765472e+11,-3.04454874997111e+14,-3.48436872331136e+14,-3.17343384667795e+14,-5.13062962395178e+11,-2.50026095109715e+09,5.04970792092224e+11,
    -2.65672842168990e+14,-3.00755396935646e+14,-3.24110558286376e+14,2.17394899509258e+12,-1.14420162307065e+11,-2.39908472683894e+12,3.13516474841052e+14,3.43599745887534e+14,4.33278681755925e+14,9.73997814571569e+12,4.36163885384137e+11,-8.86200606032246e+12,2.63753104161885e+14,2.78359940976691e+14,2.59196435110223e+14,7.56589730891406e+12,1.81710477280721e+11,-7.20591202412428e+12,-3.11596736833948e+14,-3.21204289928579e+14,-3.68364558579772e+14,1.45766652656437e+08,-3.69531001272405e+11,-7.42619920856802e+11,
    4.90271841791950e+12,4.86152648222259e+11,-3.76531907028098e+12,1.15870869347601e+12,3.00203572610118e+10,-1.09752126760294e+12,-1.01015130219440e+13,-9.82204125170920e+10,9.73997814571569e+12,1.12923125415092e+13,2.49242666976861e+11,-1.07906737513401e+13,3.59966740268918e+13,1.03497304422577e+12,-3.33548719915475e+13,9.97809704785211e+12,2.07823474271093e+11,-9.56302345498538e+12,-3.07978794228674e+13,-1.42290527993094e+12,2.73802129161128e+13,-1.55274111861326e+11,-1.18768332583866e+10,1.30373733993511e+11,
    2.84413208712192e+09,1.19334280071769e+10,2.71386823653688e+10,3.11724862673927e+10,1.62053841487598e+09,-3.02248321397223e+10,-4.67813838103413e+11,-1.27669971405675e+10,4.36163885384137e+11,2.49242666976861e+11,7.76536796141871e+09,-2.40018843484748e+11,6.65659744824589e+11,2.07388767880270e+10,-6.13297813653810e+11,2.18832686586120e+11,4.25274590905247e+09,-2.09180483416973e+11,-2.00690038808298e+11,-1.99053076546363e+10,1.49995245904305e+11,2.84508063002705e+08,-9.36497381562273e+08,1.35919875954522e+08,
    -4.89934373971060e+12,-4.64862355205941e+11,3.81675689498098e+12,-1.09521700959018e+12,-2.90727031333415e+10,1.03821831467454e+12,9.17039557190861e+12,7.77636886341669e+10,-8.86200606032246e+12,-1.07906737513401e+13,-2.40018843484748e+11,1.03137895205859e+13,-3.46680998923035e+13,-9.96585803066018e+11,3.21248406944681e+13,-9.54100503035538e+12,-1.98171271101948e+11,9.14408913247589e+12,3.03970480601055e+13,1.38368446963779e+12,-2.70795915291266e+13,1.54696416636290e+11,1.22972611973438e+10,-1.31248605592642e+11,
    -3.11905429587867e+14,-2.34366285679009e+14,-1.61067094768938e+14,1.04166744342756e+13,3.15717076994426e+11,-9.78756765168616e+12,2.35754673364290e+14,2.65474346667516e+14,2.63753104161885e+14,3.59966740268918e+13,6.65659744824589e+11,-3.46680998923035e+13,6.86818785526993e+14,2.23271715027966e+14,-7.61632837773969e+13,3.10558441722116e+13,-5.11180824669342e+11,-3.20736955953786e+13,-6.10668029303416e+14,-2.54379776016472e+14,-2.65227256155502e+13,5.47536303660346e+12,-8.60614866020053e+11,-7.19323333313113e+12,
    -2.31121170707019e+14,-2.39296600959407e+14,-2.43680925074816e+14,1.40615679123466e+11,5.85245735539342e+09,-1.31558639070770e+11,2.60594395847247e+14,2.35691852672818e+14,2.78359940976691e+14,1.03497304422577e+12,2.07388767880270e+10,-9.96585803066018e+11,2.23271715027966e+14,3.81511174303008e+14,2.20685519238928e+14,1.91732665345475e+12,1.36992163624740e+10,-1.88485095033158e+12,-2.52744940168194e+14,-3.77906426016418e+14,-2.55364535140803e+14,1.02268210276651e+12,-5.98534038481601e+08,-1.02012526978207e+12,
    -1.53393710973642e+14,-2.40435810102826e+14,-3.27221339606963e+14,-9.99830208490579e+12,-3.01267561026693e+11,9.39279858493568e+12,2.51826106769935e+14,2.73479990156423e+14,2.59196435110223e+14,-3.33548719915475e+13,-6.13297813653810e+11,3.21248406944681e+13,-7.61632837773968e+13,2.20685519238928e+14,6.72903571196811e+14,-2.67226693645490e+13,5.47079325410715e+11,2.78224723299952e+13,-2.22691120188965e+13,-2.53729699292525e+14,-6.04878666700072e+14,-3.36619228608732e+12,8.59778289621737e+11,5.08989723194116e+12,
    3.26729068365633e+12,5.89009049096880e+10,-3.05772926878262e+12,-1.19424561874221e+11,-8.67410212607193e+08,1.16543030097965e+11,-7.99098418719210e+12,-1.66663636611804e+11,7.56589730891406e+12,9.97809704785211e+12,2.18832686586119e+11,-9.54100503035538e+12,3.10558441722116e+13,1.91732665345475e+12,-2.67226693645490e+13,9.15768851215343e+12,1.90859272006350e+11,-8.77281651192531e+12,-2.63321506686759e+13,-1.80956392175263e+12,2.22145013244176e+13,-9.40070739590395e+11,-2.83629875417186e+10,8.84491475857990e+11,
    2.43742901939782e+11,6.70883042929357e+09,-2.26593392221346e+11,-9.56344826195232e+09,-9.36490547169487e+08,9.98388986969506e+09,-1.96896999570600e+11,-5.72733671501487e+09,1.81710477280721e+11,2.07823474271093e+11,4.25274590905223e+09,-1.98171271101947e+11,-5.11180824669342e+11,1.36992163624740e+10,5.47079325410715e+11,1.90859272006350e+11,6.22522894302845e+09,-1.84715726551016e+11,4.64334922300161e+11,-1.46807100767527e+10,-5.02196410470091e+11,-2.60498132760555e+10,8.04010237228048e+07,2.39171926214192e+10,
    -2.77969993866464e+12,-4.53372127776341e+10,2.60472960577473e+12,9.91509539992748e+10,1.28785182034997e+09,-9.77219617096153e+10,7.59444483298994e+12,1.52118450765472e+11,-7.20591202412428e+12,-9.56302345498538e+12,-2.09180483416972e+11,9.14408913247589e+12,-3.20736955953786e+13,-1.88485095033158e+12,2.78224723299952e+13,-8.77281651192531e+12,-1.84715726551016e+11,8.40653851503858e+12,2.72589507010533e+13,1.77806971234374e+12,-2.32212899116457e+13,8.89117824389319e+11,2.62303668870822e+10,-8.35510379264105e+11,
    3.50671368105446e+14,2.67916282680135e+14,2.20490231432865e+14,-9.22793504236511e+12,-1.92513354697953e+11,8.84356198893604e+12,-3.36448602358512e+14,-3.04454874997111e+14,-3.11596736833948e+14,-3.07978794228674e+13,-2.00690038808298e+11,3.03970480601055e+13,-6.10668029303416e+14,-2.52744940168194e+14,-2.22691120188967e+13,-2.63321506686759e+13,4.64334922300161e+11,2.72589507010533e+13,5.96445263556482e+14,2.89283532485169e+14,1.13375617419980e+14,-4.76200723932262e+12,4.72344571319030e+11,5.70545443562355e+12,
    2.65690213267629e+14,3.06969487732046e+14,2.80786387239494e+14,-2.48208093239429e+11,-5.21511123256119e+09,2.38513707063901e+11,-3.00593969736327e+14,-3.48436872331136e+14,-3.21204289928578e+14,-1.42290527993094e+12,-1.99053076546363e+10,1.38368446963779e+12,-2.54379776016472e+14,-3.77906426016419e+14,-2.53729699292525e+14,-1.80956392175263e+12,-1.46807100767527e+10,1.77806971234374e+12,2.89283532485169e+14,4.19373810615508e+14,2.94147601981610e+14,-6.34772260066661e+11,-1.86736665237921e+08,6.33000697785947e+11,
    2.15601491987278e+14,2.78560317826988e+14,3.73844761682387e+14,8.59437786476342e+12,1.79338530975886e+11,-8.23488278619929e+12,-3.02454383791707e+14,-3.17343384667795e+14,-3.68364558579771e+14,2.73802129161128e+13,1.49995245904305e+11,-2.70795915291266e+13,-2.65227256155504e+13,-2.55364535140803e+14,-6.04878666700072e+14,2.22145013244176e+13,-5.02196410470091e+11,-2.32212899116457e+13,1.13375617419979e+14,2.94147601981610e+14,5.99398463597456e+14,3.42865617420616e+12,-4.73078536328153e+11,-4.37636747842582e+12,
    3.81963688725529e+11,1.25153119695329e+11,-6.26096547715093e+10,2.83363344845121e+12,6.87703034106069e+10,-2.69666619730551e+12,-1.09531948600636e+12,-5.13062962395178e+11,1.45766652656436e+08,-1.55274111861327e+11,2.84508063002648e+08,1.54696416636291e+11,5.47536303660346e+12,1.02268210276651e+12,-3.36619228608732e+12,-9.40070739590396e+11,-2.60498132760556e+10,8.89117824389320e+11,-4.76200723932262e+12,-6.34772260066661e+11,3.42865617420616e+12,2.04881018307892e+12,4.25322273116885e+10,-1.96231233926672e+12,
    2.56897133949899e+10,3.28553165481657e+09,-1.71687520211773e+10,5.89221363548777e+10,1.04808084586671e+09,-5.56792633121032e+10,3.62580581306035e+11,-2.50026095109715e+09,-3.69531001272405e+11,-1.18768332583862e+10,-9.36497381562081e+08,1.22972611973437e+10,-8.60614866020053e+11,-5.98534038481601e+08,8.59778289621737e+11,-2.83629875417192e+10,8.04010237227104e+07,2.62303668870826e+10,4.72344571319030e+11,-1.86736665237921e+08,-4.73078536328153e+11,4.25322273116881e+10,1.87388296136305e+09,-4.16512397665638e+10,
    -3.29930605968665e+11,-1.17846220096099e+11,2.90901673414654e+10,-2.71636253141695e+12,-6.55274303678318e+10,2.58473431500575e+12,1.81770950347625e+12,5.04970792092224e+11,-7.42619920856802e+11,1.30373733993512e+11,1.35919875954961e+08,-1.31248605592643e+11,-7.19323333313113e+12,-1.02012526978207e+12,5.08989723194116e+12,8.84491475857990e+11,2.39171926214190e+10,-8.35510379264105e+11,5.70545443562355e+12,6.33000697785947e+11,-4.37636747842582e+12,-1.96231233926672e+12,-4.16512397665643e+10,1.88044324892238e+12};


  T cpu_kelem_ref_lin[] = {2.14657016955459e+13,2.37767055741204e+13,2.60968534771481e+13,1.94626369567089e+09,1.13631671943577e+09,-9.15576593871915e+08,-2.57778208845193e+13,-2.83280397389194e+13,-3.08874026177727e+13,-3.31859077587805e+09,1.79052172813772e+09,4.58604826680507e+09,-2.64153977736262e+13,-2.82864832968416e+13,-3.01625508958505e+13,-3.26847715175036e+09,5.86994439270560e+08,4.54740714240017e+09,3.07275169625996e+13,3.28378174616406e+13,3.49531000364750e+13,1.90922319088120e+09,1.07097688403351e+08,-1.04137184719419e+09,
    2.37767055741204e+13,2.64173645891222e+13,2.90397355552177e+13,-4.53952432874671e+09,-9.78639564079374e+08,1.18415625035620e+09,-2.86608278845554e+13,-3.15739951524675e+13,-3.44688743714734e+13,5.43655906354702e+09,-1.17979848003455e+09,-1.03727190216536e+10,-2.93891827133291e+13,-3.15179134200358e+13,-3.36366799751555e+13,6.59627321969525e+09,-1.29262671110574e+09,-9.03549536844030e+09,3.42733050237641e+13,3.66745439833812e+13,3.90658187914112e+13,-3.47792167787790e+09,-8.95244784591709e+08,2.42326839829012e+09,
    2.60968534771481e+13,2.90397355552177e+13,3.19917616577405e+13,1.89421615795064e+09,1.24041179487532e+09,-9.67624131590907e+08,-3.15529789090447e+13,-3.48016625171094e+13,-3.80594901496273e+13,-3.40624978677745e+09,1.96583974993060e+09,4.49838925591199e+09,-3.23679497288254e+13,-3.47393793916431e+13,-3.71157911302542e+13,-3.25478043130087e+09,5.59600998365521e+08,4.56110386285594e+09,3.78240751607220e+13,4.05013063535348e+13,4.31835196221410e+13,1.93661663178576e+09,5.23108065931643e+07,-1.01397840628842e+09,
    1.94626369567089e+09,-4.53952432874671e+09,1.89421615795064e+09,3.17245166867484e+11,2.63179351005941e+10,-2.63175907477493e+11,-1.66731112356666e+09,4.85819739016339e+09,-1.53582260722152e+09,7.18238092093166e+10,5.60068302989756e+09,-5.94757317984805e+10,8.80477356711218e+09,-1.88266500437284e+10,8.69793914758287e+09,6.15054161459181e+10,-4.42508666276693e+09,-7.15023008224924e+10,-9.08372613921642e+09,1.85079769823117e+10,-9.05633269831199e+09,3.06974529843741e+11,1.61965903828837e+10,-2.75154704753491e+11,
    1.13631671943577e+09,-9.78639564079374e+08,1.24041179487532e+09,2.63179351005941e+10,3.41400831096751e+09,-2.23566968562612e+10,-1.69422186364299e+09,3.41293441247315e+08,-1.95719889633222e+09,4.44855402351772e+09,1.62053841487610e+09,-3.50089989584729e+09,1.23322400932447e+09,-3.22421996172199e+07,1.44689284838433e+09,4.27095138657804e+09,-9.36490547169464e+08,-3.85050977883517e+09,-6.75318865117257e+08,6.69588322449279e+08,-7.30105746927427e+08,2.60447574386089e+10,1.04808084586701e+09,-2.28018843958338e+10,
    -9.15576593871915e+08,1.18415625035620e+09,-9.67624131590907e+08,-2.63175907477493e+11,-2.23566968562612e+10,2.19895902953771e+11,1.19452916597470e+09,-8.65483188941046e+08,1.32601768231845e+09,-6.17799898112399e+10,-4.65302890222710e+09,5.36206433578265e+10,-8.66569694796494e+09,1.61142909864023e+10,-8.77253136749563e+09,-5.41102247238026e+10,4.84552827050974e+09,6.26545699137808e+10,8.38674437586216e+09,-1.64329640478174e+10,8.41413781676810e+09,-2.55458370642042e+11,-1.29537173401088e+10,2.28977580286302e+11,
    -2.57778208845193e+13,-2.86608278845554e+13,-3.15529789090447e+13,-1.66731112356666e+09,-1.69422186364299e+09,1.19452916597470e+09,3.11385757894802e+13,3.43236660133402e+13,3.75179002616535e+13,3.68469747690222e+09,-2.52273513017970e+09,-4.21994156578749e+09,3.19096570736103e+13,3.42302885250046e+13,3.65559020521924e+13,2.82840816028885e+09,2.93143543658924e+08,-4.98747613386825e+09,-3.72704119785712e+13,-3.98931266537894e+13,-4.25208234048012e+13,-2.26213805342791e+09,5.98732036691393e+08,6.88456984646051e+08,
    -2.83280397389194e+13,-3.15739951524675e+13,-3.48016625171094e+13,4.85819739016339e+09,3.41293441247315e+08,-8.65483188941046e+08,3.43236660133402e+13,3.79093730993238e+13,4.14767921364011e+13,-5.01977449684826e+09,3.46229346643636e+08,1.07895035883455e+10,3.51861345951345e+13,3.77891896919113e+13,4.03822806371011e+13,-7.08702007683113e+09,2.27412042538414e+09,8.54474851129763e+09,-4.11817608695553e+13,-4.41245676387676e+13,-4.70574102563928e+13,3.08528632601879e+09,1.68051548831129e+09,-2.81590375015069e+09,
    -3.08874026177726e+13,-3.44688743714734e+13,-3.80594901496273e+13,-1.53582260722152e+09,-1.95719889633222e+09,1.32601768231845e+09,3.75179002616535e+13,4.14767921364012e+13,4.54448280356020e+13,3.87371221915077e+09,-2.90076461467045e+09,-4.03092682354574e+09,3.84675941924522e+13,4.13381267072310e+13,4.42136412978033e+13,2.71335570849065e+09,5.23248447261804e+08,-5.10252858567321e+09,-4.50980918363330e+13,-4.83460444721588e+13,-5.15989791837781e+13,-2.36897247295724e+09,8.12400875751246e+08,5.81622565115370e+08,
    -3.31859077587805e+09,5.43655906354702e+09,-3.40624978677745e+09,7.18238092093165e+10,4.44855402351772e+09,-6.17799898112399e+10,3.68469747690222e+09,-5.01977449684826e+09,3.87371221915077e+09,1.39221998874041e+12,8.00792363475240e+10,-1.22890805982999e+12,4.06642300556887e+10,-8.27586638676312e+10,4.05491776038901e+10,1.38050165156737e+12,6.93702173737421e+10,-1.24233457249540e+12,-4.10303367567129e+10,8.23418793009324e+10,-4.10166400362635e+10,6.03443609766746e+10,-6.73826750657909e+09,-7.49676073408729e+10,
    1.79052172813772e+09,-1.17979848003455e+09,1.96583974993060e+09,5.60068302989757e+09,1.62053841487610e+09,-4.65302890222711e+09,-2.52273513017970e+09,3.46229346643636e+08,-2.90076461467045e+09,8.00792363475239e+10,7.76536796141901e+09,-7.08554128554106e+10,2.72914795275327e+09,-2.59788839280410e+09,2.95925285635619e+09,8.03794296887541e+10,4.25274590905265e+09,-7.07272265196074e+10,-1.99693455071130e+09,3.43145752619501e+09,-2.02432799161634e+09,5.42307381481064e+09,-9.36497381562260e+08,-5.00264587585334e+09,
    4.58604826680507e+09,-1.03727190216536e+10,4.49838925591199e+09,-5.94757317984804e+10,-3.50089989584729e+09,5.36206433578264e+10,-4.21994156578749e+09,1.07895035883455e+10,-4.03092682354574e+09,-1.22890805982999e+12,-7.08554128554107e+10,1.09035069033453e+12,-3.79512892110794e+10,7.44723746657211e+10,-3.80663416628839e+10,-1.22031614786538e+12,-5.97180142045957e+10,1.10030676378066e+12,3.75851825100618e+10,-7.48891592324130e+10,3.75988792305176e+10,-5.06449246980941e+10,7.15869544553632e+09,6.38156042381252e+10,
    -2.64153977736262e+13,-2.93891827133291e+13,-3.23679497288255e+13,8.80477356711218e+09,1.23322400932447e+09,-8.66569694796494e+09,3.19096570736103e+13,3.51861345951344e+13,3.84675941924522e+13,4.06642300556887e+10,2.72914795275327e+09,-3.79512892110794e+10,3.28070429714619e+13,3.52117841324797e+13,3.76273095722185e+13,4.15205193723018e+10,-8.67307210857549e+07,-3.71837546429989e+10,-3.83013022714460e+13,-4.10087360142851e+13,-4.37269540358451e+13,9.39960049697306e+09,-1.05972989101026e+09,-8.15962476663657e+09,
    -2.82864832968416e+13,-3.15179134200358e+13,-3.47393793916431e+13,-1.88266500437284e+10,-3.22421996172199e+07,1.61142909864023e+10,3.42302885250046e+13,3.77891896919113e+13,4.13381267072310e+13,-8.27586638676312e+10,-2.59788839280410e+09,7.44723746657211e+10,3.52117841324797e+13,3.78341363818209e+13,4.04349200737201e+13,-8.06914182876487e+10,-4.52577947154471e+09,7.67171297427688e+10,-4.11555893606427e+13,-4.41054126536963e+13,-4.70336673893080e+13,-1.70537389795842e+10,-1.37146424668141e+09,1.80647115476118e+10,
    -3.01625508958505e+13,-3.36366799751555e+13,-3.71157911302542e+13,8.69793914758287e+09,1.44689284838433e+09,-8.77253136749563e+09,3.65559020521924e+13,4.03822806371011e+13,4.42136412978033e+13,4.05491776038901e+10,2.95925285635619e+09,-3.80663416628839e+10,3.76273095722185e+13,4.04349200737201e+13,4.32533148539427e+13,4.17095341145500e+10,-4.64760205576385e+08,-3.69947399007566e+10,-4.40206607285604e+13,-4.71805207356656e+13,-5.03511650214919e+13,9.53108901331828e+09,-1.32270692369940e+09,-8.02813625029272e+09,
    -3.26847715175036e+09,6.59627321969525e+09,-3.25478043130087e+09,6.15054161459182e+10,4.27095138657807e+09,-5.41102247238026e+10,2.82840816028885e+09,-7.08702007683113e+09,2.71335570849065e+09,1.38050165156737e+12,8.03794296887541e+10,-1.22031614786538e+12,4.15205193723018e+10,-8.06914182876487e+10,4.17095341145500e+10,1.37131563878098e+12,6.77018918785219e+10,-1.23275839880857e+12,-4.10804503808402e+10,8.11821651447846e+10,-4.11681093917397e+10,5.20805068562292e+10,-7.92878888548753e+09,-6.67913732761627e+10,
    5.86994439270560e+08,-1.29262671110574e+09,5.59600998365521e+08,-4.42508666276691e+09,-9.36490547169468e+08,4.84552827050971e+09,2.93143543658924e+08,2.27412042538414e+09,5.23248447261804e+08,6.93702173737420e+10,4.25274590905264e+09,-5.97180142045957e+10,-8.67307210857549e+07,-4.52577947154471e+09,-4.64760205576385e+08,6.77018918785219e+10,6.22522894302891e+09,-6.15583464231885e+10,-7.93407261843728e+08,3.54428575726631e+09,-6.18089240050943e+08,-5.61561461982263e+09,8.04010237226391e+07,3.48299396518611e+09,
    4.54740714240017e+09,-9.03549536844030e+09,4.56110386285594e+09,-7.15023008224924e+10,-3.85050977883522e+09,6.26545699137808e+10,-4.98747613386825e+09,8.54474851129763e+09,-5.10252858567321e+09,-1.24233457249540e+12,-7.07272265196074e+10,1.10030676378066e+12,-3.71837546429989e+10,7.67171297427688e+10,-3.69947399007566e+10,-1.23275839880857e+12,-6.15583464231885e+10,1.11279516217755e+12,3.76238236344670e+10,-7.62263828856261e+10,3.75361646235738e+10,-6.21650247448332e+10,5.79616823085100e+09,7.49040725575753e+10,
    3.07275169625996e+13,3.42733050237641e+13,3.78240751607221e+13,-9.08372613921642e+09,-6.75318865117257e+08,8.38674437586216e+09,-3.72704119785712e+13,-4.11817608695553e+13,-4.50980918363330e+13,-4.10303367567129e+10,-1.99693455071130e+09,3.75851825100618e+10,-3.83013022714460e+13,-4.11555893606427e+13,-4.40206607285604e+13,-4.10804503808402e+10,-7.93407261843728e+08,3.76238236344670e+10,4.48441972874175e+13,4.80640452064339e+13,5.12946774041713e+13,-9.04668563442635e+09,3.53900165915514e+08,8.51253962918471e+09,
    3.28378174616406e+13,3.66745439833812e+13,4.05013063535348e+13,1.85079769823117e+10,6.69588322449279e+08,-1.64329640478174e+10,-3.98931266537894e+13,-4.41245676387676e+13,-4.83460444721588e+13,8.23418793009324e+10,3.43145752619501e+09,-7.48891592324130e+10,-4.10087360142851e+13,-4.41054126536963e+13,-4.71805207356656e+13,8.11821651447846e+10,3.54428575726631e+09,-7.62263828856261e+10,4.80640452064339e+13,5.15554363090827e+13,5.50252588542896e+13,1.74463743314433e+10,5.86193542961837e+08,-1.76720761957512e+10,
    3.49531000364750e+13,3.90658187914112e+13,4.31835196221410e+13,-9.05633269831199e+09,-7.30105746927427e+08,8.41413781676810e+09,-4.25208234048012e+13,-4.70574102563928e+13,-5.15989791837780e+13,-4.10166400362635e+10,-2.02432799161634e+09,3.75988792305176e+10,-4.37269540358452e+13,-4.70336673893080e+13,-5.03511650214919e+13,-4.11681093917397e+10,-6.18089240050943e+08,3.75361646235738e+10,5.12946774041713e+13,5.50252588542896e+13,5.87666245831289e+13,-9.09873317214680e+09,4.57995241354983e+08,8.46049209146577e+09,
    1.90922319088120e+09,-3.47792167787790e+09,1.93661663178576e+09,3.06974529843741e+11,2.60447574386089e+10,-2.55458370642042e+11,-2.26213805342791e+09,3.08528632601879e+09,-2.36897247295724e+09,6.03443609766744e+10,5.42307381481060e+09,-5.06449246980940e+10,9.39960049697306e+09,-1.70537389795842e+10,9.53108901331828e+09,5.20805068562290e+10,-5.61561461982262e+09,-6.21650247448329e+10,-9.04668563442635e+09,1.74463743314433e+10,-9.09873317214680e+09,2.98662927246546e+11,1.51016490471734e+10,-2.67026239963396e+11,
    1.07097688403351e+08,-8.95244784591709e+08,5.23108065931644e+07,1.61965903828838e+10,1.04808084586702e+09,-1.29537173401088e+10,5.98732036691392e+08,1.68051548831129e+09,8.12400875751246e+08,-6.73826750657909e+09,-9.36497381562263e+08,7.15869544553632e+09,-1.05972989101026e+09,-1.37146424668141e+09,-1.32270692369940e+09,-7.92878888548761e+09,8.04010237226136e+07,5.79616823085103e+09,3.53900165915514e+08,5.86193542961836e+08,4.57995241354983e+08,1.51016490471734e+10,1.87388296136318e+09,-1.42206615020491e+10,
    -1.04137184719419e+09,2.42326839829012e+09,-1.01397840628842e+09,-2.75154704753491e+11,-2.28018843958338e+10,2.28977580286302e+11,6.88456984646051e+08,-2.81590375015069e+09,5.81622565115370e+08,-7.49676073408727e+10,-5.00264587585331e+09,6.38156042381251e+10,-8.15962476663657e+09,1.80647115476118e+10,-8.02813625029272e+09,-6.67913732761626e+10,3.48299396518605e+09,7.49040725575751e+10,8.51253962918471e+09,-1.76720761957512e+10,8.46049209146577e+09,-2.67026239963396e+11,-1.42206615020491e+10,2.40018306148096e+11};


  using Quad = QuadLinearQuadrature<T>;
  using Director = LinearizedRotation<T>;
  using Basis = ShellQuadBasis<T, Quad, 2>;
  using Geo = Basis::Geo;

  constexpr bool has_ref_axis = false;
  using Data = ShellIsotropicData<T, has_ref_axis>;
  using Physics = IsotropicShell<T, Data, is_nonlinear>;

  using ElemGroup = ShellElementGroup<T, Director, Basis, Physics>;
  using Assembler = ElementAssembler<T, ElemGroup, VecType, DenseMat>;

  // printf("running!\n");
  int num_bcs = 2;
  auto assembler = createOneElementAssembler<Assembler>(num_bcs);

  // init variables u
  int num_vars = assembler.get_num_vars();
  auto res = assembler.createVarsVec();
  auto h_vars = HostVec<T>(num_vars);
  auto p_vars = HostVec<T>(num_vars);
  auto p_vars2 = HostVec<T>(num_vars);

  // fixed perturbations of the host and pert vars
  for (int ivar = 0; ivar < 24; ivar++) {
    h_vars[ivar] = (1.4543 + 6.4323 * ivar) * 1e-6;
    if (is_nonlinear) h_vars[ivar] *= 1e6;
    p_vars[ivar] = (-1.4543 + 2.312 * 6.4323 * ivar);
    p_vars2[ivar] = (-1.4543 * 1.024343 + 2.812 * -9.4323 * ivar);
  }

  auto vars = h_vars.createDeviceVec();
  assembler.set_variables(vars);

  DenseMat<VecType<T>> mat(num_vars);

  // time add residual method
  auto start = std::chrono::high_resolution_clock::now();

  assembler.add_jacobian(res, mat);

  auto stop = std::chrono::high_resolution_clock::now();
  auto duration =
      std::chrono::duration_cast<std::chrono::microseconds>(stop - start);

  // print res, jac
  auto h_res = res.createHostVec();
  auto h_mat = mat.createHostVec();
  T jac_TD = 0.0;
  T res_TD = 0.0;
  for (int i = 0; i < 24; i++) {
    res_TD += p_vars[i] * h_res[i];
    for (int j = 0; j < 24; j++) {
      jac_TD += p_vars[i] * p_vars2[j] * h_mat[24 * i + j];
    }
  }

  if (print) {
    printf("Analytic Jacobian GPU\n");
    printf("res TD = %.8e\n", res_TD);
    printf("jac TD = %.8e\n", jac_TD);
  }

  // print residual
  if (print) {
    printf("res: ");
    printVec<double>(num_vars, h_res.getPtr());
  }

  const double *h_mat_ptr = h_mat.getPtr();
  if (print) {
    for (int i = 0; i < 24; i++) {  // i < 2
      printf("kmat row %d: ", i);
      printVec<double>(num_vars, &h_mat_ptr[num_vars * i]);
    }
  }  

  if constexpr (is_nonlinear) {
    double max_ref = max(576, cpu_kelem_ref_nl);
    double max_abs_err = abs_err(h_mat, cpu_kelem_ref_nl);
    double my_rel_err = max_abs_err / max_ref;
    bool passed = my_rel_err < 1e-10;
    T max_rel_err = rel_err(h_mat, cpu_kelem_ref_nl, 1e-9);
    printTestReport("shell elem-jac geom nonlinear", passed, my_rel_err);
    printf("\tabs err %.4e, max ref %.4e, norm err %.4e, max rel err %.4e\n", max_abs_err, max_ref, my_rel_err, max_rel_err);
  } else {
    double max_ref = max(576, cpu_kelem_ref_lin);
    double max_abs_err = abs_err(h_mat, cpu_kelem_ref_lin);
    double my_rel_err = max_abs_err / max_ref;
    bool passed = my_rel_err < 1e-10;
    T max_rel_err = rel_err(h_mat, cpu_kelem_ref_lin, 1e-9);
    printTestReport("shell elem-jac linear", passed, my_rel_err);
    printf("\tabs err %.4e, max ref %.4e, norm err %.4e, max rel err %.4e\n", max_abs_err, max_ref, my_rel_err, max_rel_err);
  }

  // temp debug
  constexpr bool debug = false;
  if constexpr (is_nonlinear && debug) {
    for (int i = 0; i < 576; i++) {
      double val1 = h_mat[i];
      double val2 = cpu_kelem_ref_nl[i];
      double my_rel_err = rel_err(val1, val2);
      int row = i / 24;
      int col = i % 24;
      printf("row %d, col %d : GPU %.4e, CPU %.4e, rel_err %.4e\n", row, col, val1, val2, my_rel_err);
    }
  }

  printKernelTiming(duration.count());
}

int main(void) {

  test_kelem_gpu<false>(); // linear
  test_kelem_gpu<true>(); // nonlinear

  return 0;
};