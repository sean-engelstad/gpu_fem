
TACS_DIR = ${HOME}/git/_archive/tacs

# GPU_FEM include
include ../../Makefile.in

# TACS include
include ${TACS_DIR}/Makefile.in
include ${TACS_DIR}/TACS_Common.mk

default: res-gpu

check-res:
# check residual against TACS
	make clean
	make res-gpu
	./res-gpu.out >> out1.txt
	make res-tacs
	./tacs-res.x >> out2.txt
	diff out1.txt out2.txt >> diff.txt

check-resNL:
# check residual against TACS
	make clean
	make res-gpuNL
	./res-gpu.out >> out1.txt
	make res-tacsNL
	./tacs-res.x >> out2.txt
	diff out1.txt out2.txt >> diff.txt

res-gpu:
    # builds analytic residual on GPU
	@echo "Building with GPU support"
	${GPU_CXX} ${GPU_CC_FLAGS} -DUSE_GPU -Xcompiler ${INCLUDE_FLAGS} -std=c++17 res.cu -o res-gpu.out

res-gpuNL:
    # builds analytic residual on GPU
	@echo "Building NL with GPU support"
	${GPU_CXX} ${GPU_CC_FLAGS} -DUSE_GPU -DNLINEAR -Xcompiler ${INCLUDE_FLAGS} -std=c++17 res.cu -o res-gpu.out

res-tacs: res-tacs.o
	@echo "Building with TACS CPU"
	${CXX} -o tacs-res.x res-tacs.o ${TACS_LD_FLAGS}

res-tacsNL:
	@echo "Building NL with TACS CPU"
	${CXX} -DNLINEAR ${TACS_CC_FLAGS} -std=c++11 -c res-tacs.cpp -o res-tacs.o
	${CXX} -o tacs-res.x res-tacs.o ${TACS_LD_FLAGS}

# check-res-cs:
# # check residual complex-step
# 	make clean
# 	make res-gpu
# 	./res-gpu.out >> out-anl.txt
# 	make res-cs
# 	./res-cs.out >> out-cs.txt
# 	diff out-anl.txt out-cs.txt >> diff.txt

# res-cs:
#     # complex-step residual
# 	@echo "Building with CPU support"
# 	g++ -x c++ ${CC_FLAGS} ${INCLUDE_FLAGS} -std=c++17 res_cs.cu -o res-cs.out

clean:
	rm *.out || echo "no .out files"
	rm *.txt || echo "no .txt files"
	rm *.o || echo "no .o files to remove"
	rm *.x || echo "no .x files to remove"

run:
	${MAKE} clean
	${MAKE} 2> make.txt
	./a.out